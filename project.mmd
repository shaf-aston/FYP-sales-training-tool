---
config:
  layout: dagre
  theme: mc
---
flowchart LR
 subgraph subGraph0["Frontend Layer"]
        UI["React.js Web Interface"]
        Admin["Admin Panel"]
  end
 subgraph subGraph1["API Layer"]
        API["FastAPI Backend"]
  end
 subgraph subGraph2["Core Services"]
        Chat["Chat Service"]
        Config["Configuration Service"]
        Memory["Context Memory"]
  end
 subgraph subGraph3["ML Processing Pipeline"]
        PreProc["Preprocessing<br>STT, Context Assembly"]
        Inference["Inference<br>LLM (Qwen2.5-0.5B)"]
        PostProc["Post-Processing<br>Filtering"]
        Enhanced["Enhancement<br>Character Consistency"]
        Fallback["Fallback<br>Rule-Based"]
        Feedback["Feedback<br>Conversation Analysis"]
        Analytics["Analytics<br>Metrics Tracking"]
  end
 subgraph subGraph4["TTS Layer"]
        TTS["Text-to-Speech<br>(ElevenLabs)"]
        EmotionTTS["Emotion-Aware TTS"]
  end
 subgraph subGraph5["Model Infrastructure"]
        Tokenizer["Tokenizer Cache"]
        ModelCache["Model Cache"]
        ModelConfig["Model Config"]
        Optimizer["Optimizer"]
        PersonaDB["Persona DB"]
        AVStorage["AV Storage"]
  end
 subgraph subGraph6["Data Storage"]
        Logs["Logs"]
        Stats["Stats"]
        Cache["Cache"]
        Profile["Profile"]
  end
 subgraph Utilities["Utilities"]
        Health["Health"]
        Cleanup["Cleanup"]
        Download["Download"]
  end
 subgraph subGraph7["Output Layer"]
        AIVoice["AI Voice"]
        AIText["AI Text"]
        PerfFeedback["Feedback"]
        SessionReport["Report"]
  end

    UI -- Calls --> API
    Admin -- Configures --> API
    API -- Routes --> Chat
    API -- Reads/Writes --> Config & Memory
    API -- Monitors --> Health
    Chat -- Processes --> PreProc

    PreProc --> Inference
    Inference --> PostProc
    PostProc --> Enhanced
    Enhanced --> Fallback

    Fallback & Enhanced -- Generates --> AIText & AIVoice

    AIText & AIVoice --> TTS
    TTS --> EmotionTTS
    EmotionTTS --> AIVoice

    AIText & AIVoice --> PerfFeedback & SessionReport

    Inference -- Uses --> subGraph5

    Chat -- Logs --> Logs & Stats & Cache & Profile

    Download -- Downloads --> ModelCache & Tokenizer
    Cleanup -- Clears --> ModelCache & Cache
    PostProc -- Generates --> Feedback & Analytics
    Feedback --> PerfFeedback
    Analytics --> SessionReport
    PersonaDB & AVStorage -- Stores --> Profile

     UI:::frontend
     Admin:::frontend
     API:::api
     Chat:::core
     Config:::core
     Memory:::core
     PreProc:::ml
     Inference:::ml
     PostProc:::ml
     Enhanced:::ml
     Fallback:::ml
     Feedback:::ml
     Analytics:::ml
     TTS:::tts
     EmotionTTS:::tts
     Tokenizer:::model
     ModelCache:::model
     ModelConfig:::model
     Optimizer:::model
     PersonaDB:::model
     AVStorage:::model
     Logs:::data
     Stats:::data
     Cache:::data
     Profile:::data
     Health:::utils
     Cleanup:::utils
     Download:::utils
     AIVoice:::output
     AIText:::output
     PerfFeedback:::output
     SessionReport:::output

    classDef frontend fill:#e1f5fe
    classDef api fill:#f3e5f5
    classDef core fill:#e8f5e8
    classDef ml fill:#fff3e0
    classDef tts fill:#ffe0b2
    classDef model fill:#f1f8e9
    classDef data fill:#fce4ec
    classDef output fill:#e0f2f1
    classDef utils fill:#e0e0e0