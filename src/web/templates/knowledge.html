<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Knowledge Base - Sales Chatbot</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #0b1220, #071018);
        color: #dcd6c9;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 20px;
      }
      .container {
        width: 100%;
        max-width: 920px;
        background: linear-gradient(
          180deg,
          rgba(12, 18, 28, 0.95),
          rgba(6, 10, 16, 0.95)
        );
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        max-height: 95vh;
      }
      /* Header */
      .header {
        padding: 14px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        background: rgba(255, 255, 255, 0.02);
      }
      .header h1 {
        font-size: 18px;
        font-weight: 600;
        color: #f3ecd7;
      }
      .header-r {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .status {
        font-size: 12px;
        transition: opacity 0.3s;
      }
      .status.ok {
        color: #4ade80;
      }
      .status.err {
        color: #f87171;
      }
      .nav-btn {
        background: rgba(255, 255, 255, 0.03);
        color: #e6ddc8;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        text-decoration: none;
      }
      .nav-btn:hover {
        background: rgba(183, 119, 31, 0.15);
        border-color: rgba(183, 119, 31, 0.3);
        color: #f7e9d1;
      }
      /* Layout */
      .kb-body {
        display: flex;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
      /* Sidebar nav */
      .side {
        width: 160px;
        min-width: 160px;
        background: rgba(255, 255, 255, 0.015);
        border-right: 1px solid rgba(255, 255, 255, 0.04);
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        gap: 1px;
      }
      .side a {
        display: flex;
        align-items: center;
        gap: 7px;
        padding: 9px 14px;
        color: #8a8378;
        font-size: 12px;
        text-decoration: none;
        border-left: 3px solid transparent;
        transition: all 0.12s;
        position: relative;
      }
      .side a:hover {
        color: #c9bda8;
        background: rgba(255, 255, 255, 0.02);
      }
      .side a.active {
        color: #f3ecd7;
        background: rgba(183, 119, 31, 0.08);
        border-left-color: #b7791f;
      }
      .side a .dot {
        position: absolute;
        right: 10px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #b7791f;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .side a .dot.on {
        opacity: 1;
      }
      /* Scroll area */
      .scroll {
        flex: 1;
        overflow-y: auto;
        padding: 16px 22px 20px;
        display: flex;
        flex-direction: column;
        gap: 18px;
        scrollbar-width: thin;
        scrollbar-color: rgba(183, 119, 31, 0.5) rgba(255, 255, 255, 0.03);
        scroll-behavior: smooth;
      }
      .scroll::-webkit-scrollbar {
        width: 7px;
      }
      .scroll::-webkit-scrollbar-thumb {
        background: rgba(183, 119, 31, 0.5);
        border-radius: 4px;
      }
      .note {
        font-size: 11px;
        color: #6b6460;
        background: rgba(183, 119, 31, 0.06);
        border-left: 2px solid rgba(183, 119, 31, 0.3);
        padding: 6px 10px;
        border-radius: 0 4px 4px 0;
        line-height: 1.4;
      }
      /* Fields */
      .field {
        display: flex;
        flex-direction: column;
        gap: 5px;
        scroll-margin-top: 12px;
      }
      .field label {
        font-size: 13px;
        font-weight: 600;
        color: #c9bda8;
      }
      .field .hint {
        font-size: 11px;
        color: #6b6460;
      }
      .field input,
      .field textarea {
        padding: 9px 12px;
        background: rgba(255, 255, 255, 0.02);
        color: #e6ddc8;
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        font-size: 13px;
        font-family: inherit;
        line-height: 1.5;
        transition: border-color 0.15s;
        width: 100%;
      }
      .field input:focus,
      .field textarea:focus {
        outline: none;
        border-color: rgba(183, 119, 31, 0.3);
        box-shadow: 0 3px 10px rgba(15, 10, 6, 0.2);
      }
      .field textarea {
        resize: vertical;
        min-height: 72px;
        scrollbar-width: thin;
        scrollbar-color: rgba(183, 119, 31, 0.4) transparent;
      }
      .field .cc {
        font-size: 10px;
        color: #6b6460;
        text-align: right;
      }
      .cc.warn {
        color: #f59e0b;
      }
      .cc.over {
        color: #f87171;
      }
      /* Footer */
      .actions {
        padding: 10px 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.02);
        display: flex;
        gap: 10px;
        align-items: center;
        background: rgba(255, 255, 255, 0.01);
      }
      .btn-save {
        background: #b7791f;
        color: #071018;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition:
          background 0.15s,
          transform 0.06s;
      }
      .btn-save:hover {
        background: #9a5f10;
        transform: translateY(-1px);
      }
      .btn-clear {
        background: rgba(255, 255, 255, 0.03);
        color: #e6ddc8;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
        transition: all 0.15s;
      }
      .btn-clear:hover {
        background: rgba(220, 38, 38, 0.15);
        border-color: rgba(220, 38, 38, 0.3);
        color: #fca5a5;
      }
      /* Preview */
      .preview {
        padding: 0 20px 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.03);
      }
      .preview summary {
        font-size: 12px;
        color: #8a8378;
        cursor: pointer;
        padding: 8px 0;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .preview summary::-webkit-details-marker {
        display: none;
      }
      .preview summary::before {
        content: "\25B6";
        font-size: 9px;
        transition: transform 0.15s;
        display: inline-block;
      }
      .preview[open] summary::before {
        transform: rotate(90deg);
      }
      .preview summary:hover {
        color: #c9bda8;
      }
      .preview pre {
        margin-top: 6px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        color: #b0a898;
        white-space: pre-wrap;
        line-height: 1.5;
        max-height: 160px;
        overflow-y: auto;
      }
      /* Responsive */
      @media (max-width: 640px) {
        body {
          padding: 0;
        }
        .container {
          height: 100vh;
          height: 100dvh;
          max-height: none;
          border-radius: 0;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
          padding: 16px;
        }
        .header-r {
          width: 100%;
          justify-content: flex-start;
          gap: 16px;
        }
        .kb-body {
          flex-direction: column;
        }
        .side {
          width: 100%;
          min-width: unset;
          flex-direction: row;
          overflow-x: auto;
          border-right: none;
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
          padding: 0;
        }
        .side a {
          border-left: none;
          border-bottom: 2px solid transparent;
          white-space: nowrap;
          padding: 9px 12px;
        }
        .side a.active {
          border-bottom-color: #b7791f;
          border-left-color: transparent;
        }
        .side a .dot {
          right: 4px;
          top: 4px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Knowledge Base</h1>
        <div class="header-r">
          <span class="status" id="st"></span>
          <a href="/" class="nav-btn">Back to Chat</a>
        </div>
      </div>
      <div class="kb-body">
        <nav class="side" id="nav"></nav>
        <div class="scroll" id="scroll">
          <p class="note">
            Supplements the product selected on the chat page. Don't repeat
            built-in knowledge — add details specific to your scenario.
          </p>
        </div>
      </div>
      <details class="preview" id="preview">
        <summary>Preview what the chatbot sees</summary>
        <pre id="previewText">(no data entered)</pre>
      </details>
      <div class="actions">
        <button class="btn-save" onclick="save()">Save</button>
        <button class="btn-clear" onclick="clearAll()">Clear All</button>
      </div>
    </div>
    <script>
      const F = [
        {
          id: "product_name",
          icon: "\u{1F4E6}",
          label: "Product",
          title: "Product / Service Name",
          hint: "The name of the product or service.",
          max: 100,
          tag: "input",
          ph: "e.g., BMW 5 Series, Pro CRM Plan, Dark Oud Fragrance",
        },
        {
          id: "pricing",
          icon: "\u{1F4B0}",
          label: "Pricing",
          title: "Pricing Information",
          hint: "Tiers, per-unit pricing, discounts. The chatbot quotes this exactly.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Starter: $29/user/mo, Pro: $79/user/mo\nBase $22k, Sport $26k, Premium $30k",
        },
        {
          id: "specifications",
          icon: "\u2699\uFE0F",
          label: "Features",
          title: "Specifications / Features",
          hint: "Key specs, technical details, capacity limits.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., 335hp twin-turbo, leather interior, 26 MPG\nAPI access, unlimited storage, SSO",
        },
        {
          id: "company_info",
          icon: "\u{1F3E2}",
          label: "Company",
          title: "Company Information",
          hint: "Background the chatbot can reference about your company.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Founded 2018, 500+ clients served\nAuthorized dealer, award-winning support",
        },
        {
          id: "selling_points",
          icon: "\u2B50",
          label: "Selling Pts",
          title: "Key Selling Points",
          hint: "Unique value propositions and differentiators vs competitors.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Best resale value in class, 10-year warranty\nMoney-back guarantee, 24/7 support",
        },
        {
          id: "additional_notes",
          icon: "\u{1F4DD}",
          label: "Notes",
          title: "Additional Notes",
          hint: "Target audience, common objections, seasonal offers.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Target: first-time buyers, enterprise teams\nCommon objection: 'too expensive' \u2014 counter with ROI",
        },
      ];

      const nav = document.getElementById("nav"),
        scroll = document.getElementById("scroll");

      // Build DOM from field config — no repeated HTML
      F.forEach((f) => {
        const a = document.createElement("a");
        a.href = "#s-" + f.id;
        a.dataset.id = f.id;
        a.innerHTML =
          f.icon +
          " " +
          f.label +
          '<span class="dot" id="d-' +
          f.id +
          '"></span>';
        a.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .getElementById("s-" + f.id)
            .scrollIntoView({ behavior: "smooth" });
        });
        nav.appendChild(a);

        const div = document.createElement("div");
        div.className = "field";
        div.id = "s-" + f.id;
        const inp =
          f.tag === "input"
            ? '<input id="' +
              f.id +
              '" maxlength="' +
              f.max +
              '" placeholder="' +
              f.ph +
              '">'
            : '<textarea id="' +
              f.id +
              '" maxlength="' +
              f.max +
              '" placeholder="' +
              f.ph +
              '"></textarea>';
        div.innerHTML =
          "<label>" +
          f.title +
          '</label><span class="hint">' +
          f.hint +
          "</span>" +
          inp +
          '<span class="cc" id="c-' +
          f.id +
          '">0 / ' +
          f.max +
          "</span>";
        scroll.appendChild(div);
      });

      // Live updates: char count + filled dots + preview
      function updPreview() {
        const lines = [];
        F.forEach((f) => {
          const v = document.getElementById(f.id).value.trim();
          if (v) lines.push(f.id + ": " + v);
        });
        const pre = document.getElementById("previewText");
        if (lines.length) {
          pre.textContent =
            "--- BEGIN CUSTOM PRODUCT DATA ---\n" +
            lines.join("\n") +
            "\n--- END CUSTOM PRODUCT DATA ---";
        } else {
          pre.textContent = "(no data entered)";
        }
      }
      function upd() {
        updPreview();
        F.forEach((f) => {
          const el = document.getElementById(f.id),
            cc = document.getElementById("c-" + f.id),
            dot = document.getElementById("d-" + f.id);
          if (!el) return;
          const len = el.value.length;
          cc.textContent = len + " / " + f.max;
          cc.className =
            "cc" +
            (len > f.max * 0.9 ? (len >= f.max ? " over" : " warn") : "");
          dot.classList.toggle("on", el.value.trim().length > 0);
        });
      }
      F.forEach((f) => {
        const el = document.getElementById(f.id);
        if (el) el.addEventListener("input", upd);
      });

      // Scroll-spy: highlight sidebar link for visible section
      const obs = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => {
            if (e.isIntersecting)
              nav
                .querySelectorAll("a")
                .forEach((a) =>
                  a.classList.toggle(
                    "active",
                    a.dataset.id === e.target.id.replace("s-", ""),
                  ),
                );
          });
        },
        { root: scroll, threshold: 0.4 },
      );
      F.forEach((f) => obs.observe(document.getElementById("s-" + f.id)));

      // Status toast
      function msg(t, err) {
        const el = document.getElementById("st");
        el.textContent = t;
        el.className = "status " + (err ? "err" : "ok");
        setTimeout(() => (el.textContent = ""), 3000);
      }

      // CRUD
      function load() {
        fetch("/api/knowledge")
          .then((r) => r.json())
          .then((d) => {
            if (d.success && d.data)
              F.forEach((f) => {
                const el = document.getElementById(f.id);
                if (el && d.data[f.id]) el.value = d.data[f.id];
              });
            upd();
          })
          .catch(() => {});
      }

      function save() {
        const p = {};
        let has = false,
          short = [];
        F.forEach((f) => {
          const v = document.getElementById(f.id).value.trim();
          if (v) {
            p[f.id] = v;
            has = true;
            if (v.length < 10 && f.id !== "product_name") short.push(f.title);
          }
        });
        if (!has) return msg("Fill in at least one field", true);
        if (
          short.length &&
          !confirm(
            "These fields have very little detail:\n\n" +
              short.join(", ") +
              "\n\nSave anyway?",
          )
        )
          return;
        fetch("/api/knowledge", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(p),
        })
          .then((r) => r.json())
          .then((d) =>
            d.success
              ? msg("Saved", false)
              : msg("Failed: " + (d.error || "Unknown"), true),
          )
          .catch((e) => msg("Error: " + e, true));
      }

      function clearAll() {
        if (!confirm("Clear all knowledge base data?")) return;
        fetch("/api/knowledge", { method: "DELETE" })
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              F.forEach((f) => (document.getElementById(f.id).value = ""));
              upd();
              msg("Cleared", false);
            } else msg("Failed to clear", true);
          })
          .catch((e) => msg("Error: " + e, true));
      }

      document.addEventListener("DOMContentLoaded", load);
    </script>
  </body>
</html>
