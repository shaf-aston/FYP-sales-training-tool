<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Knowledge Base - Sales Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='knowledge.css') }}">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Knowledge Base</h1>
        <div class="header-r">
          <span class="status" id="st"></span>
          <a href="/" class="nav-btn">Back to Chat</a>
        </div>
      </div>
      <div class="kb-body">
        <nav class="side" id="nav"></nav>
        <div class="scroll" id="scroll">
          <p class="note">
            Supplements the product selected on the chat page. Don't repeat
            built-in knowledge — add details specific to your scenario.
          </p>
        </div>
      </div>
      <details class="preview" id="preview">
        <summary>Preview what the chatbot sees</summary>
        <pre id="previewText">(no data entered)</pre>
      </details>
      <div class="actions">
        <button class="btn-save" onclick="save()">Save</button>
        <button class="btn-clear" onclick="clearAll()">Clear All</button>
      </div>
    </div>
    <script>
      const F = [
        {
          id: "product_name",
          icon: "\u{1F4E6}",
          label: "Product",
          title: "Product / Service Name",
          hint: "The name of the product or service.",
          max: 100,
          tag: "input",
          ph: "e.g., BMW 5 Series, Pro CRM Plan, Dark Oud Fragrance",
        },
        {
          id: "pricing",
          icon: "\u{1F4B0}",
          label: "Pricing",
          title: "Pricing Information",
          hint: "Tiers, per-unit pricing, discounts. The chatbot quotes this exactly.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Starter: $29/user/mo, Pro: $79/user/mo\nBase $22k, Sport $26k, Premium $30k",
        },
        {
          id: "specifications",
          icon: "\u2699\uFE0F",
          label: "Features",
          title: "Specifications / Features",
          hint: "Key specs, technical details, capacity limits.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., 335hp twin-turbo, leather interior, 26 MPG\nAPI access, unlimited storage, SSO",
        },
        {
          id: "company_info",
          icon: "\u{1F3E2}",
          label: "Company",
          title: "Company Information",
          hint: "Background the chatbot can reference about your company.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Founded 2018, 500+ clients served\nAuthorized dealer, award-winning support",
        },
        {
          id: "selling_points",
          icon: "\u2B50",
          label: "Selling Pts",
          title: "Key Selling Points",
          hint: "Unique value propositions and differentiators vs competitors.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Best resale value in class, 10-year warranty\nMoney-back guarantee, 24/7 support",
        },
        {
          id: "additional_notes",
          icon: "\u{1F4DD}",
          label: "Notes",
          title: "Additional Notes",
          hint: "Target audience, common objections, seasonal offers.",
          max: 1000,
          tag: "textarea",
          ph: "e.g., Target: first-time buyers, enterprise teams\nCommon objection: 'too expensive' \u2014 counter with ROI",
        },
      ];

      const nav = document.getElementById("nav"),
        scroll = document.getElementById("scroll");

      // Build DOM from field config — no repeated HTML
      F.forEach((f) => {
        const a = document.createElement("a");
        a.href = "#s-" + f.id;
        a.dataset.id = f.id;
        a.innerHTML =
          f.icon +
          " " +
          f.label +
          '<span class="dot" id="d-' +
          f.id +
          '"></span>';
        a.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .getElementById("s-" + f.id)
            .scrollIntoView({ behavior: "smooth" });
        });
        nav.appendChild(a);

        const div = document.createElement("div");
        div.className = "field";
        div.id = "s-" + f.id;
        const inp =
          f.tag === "input"
            ? '<input id="' +
              f.id +
              '" maxlength="' +
              f.max +
              '" placeholder="' +
              f.ph +
              '">'
            : '<textarea id="' +
              f.id +
              '" maxlength="' +
              f.max +
              '" placeholder="' +
              f.ph +
              '"></textarea>';
        div.innerHTML =
          "<label>" +
          f.title +
          '</label><span class="hint">' +
          f.hint +
          "</span>" +
          inp +
          '<span class="cc" id="c-' +
          f.id +
          '">0 / ' +
          f.max +
          "</span>";
        scroll.appendChild(div);
      });

      // Live updates: char count + filled dots + preview
      function updPreview() {
        const lines = [];
        F.forEach((f) => {
          const v = document.getElementById(f.id).value.trim();
          if (v) lines.push(f.id + ": " + v);
        });
        const pre = document.getElementById("previewText");
        if (lines.length) {
          pre.textContent =
            "--- BEGIN CUSTOM PRODUCT DATA ---\n" +
            lines.join("\n") +
            "\n--- END CUSTOM PRODUCT DATA ---";
        } else {
          pre.textContent = "(no data entered)";
        }
      }
      function upd() {
        updPreview();
        F.forEach((f) => {
          const el = document.getElementById(f.id),
            cc = document.getElementById("c-" + f.id),
            dot = document.getElementById("d-" + f.id);
          if (!el) return;
          const len = el.value.length;
          cc.textContent = len + " / " + f.max;
          cc.className =
            "cc" +
            (len > f.max * 0.9 ? (len >= f.max ? " over" : " warn") : "");
          dot.classList.toggle("on", el.value.trim().length > 0);
        });
      }
      F.forEach((f) => {
        const el = document.getElementById(f.id);
        if (el) el.addEventListener("input", upd);
      });

      // Scroll-spy: highlight sidebar link for visible section
      const obs = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => {
            if (e.isIntersecting)
              nav
                .querySelectorAll("a")
                .forEach((a) =>
                  a.classList.toggle(
                    "active",
                    a.dataset.id === e.target.id.replace("s-", ""),
                  ),
                );
          });
        },
        { root: scroll, threshold: 0.4 },
      );
      F.forEach((f) => obs.observe(document.getElementById("s-" + f.id)));

      // Status toast
      function msg(t, err) {
        const el = document.getElementById("st");
        el.textContent = t;
        el.className = "status " + (err ? "err" : "ok");
        setTimeout(() => (el.textContent = ""), 3000);
      }

      // CRUD
      function load() {
        fetch("/api/knowledge")
          .then((r) => r.json())
          .then((d) => {
            if (d.success && d.data)
              F.forEach((f) => {
                const el = document.getElementById(f.id);
                if (el && d.data[f.id]) el.value = d.data[f.id];
              });
            upd();
          })
          .catch(() => {});
      }

      function save() {
        const p = {};
        let has = false,
          short = [];
        F.forEach((f) => {
          const v = document.getElementById(f.id).value.trim();
          if (v) {
            p[f.id] = v;
            has = true;
            if (v.length < 10 && f.id !== "product_name") short.push(f.title);
          }
        });
        if (!has) return msg("Fill in at least one field", true);
        if (
          short.length &&
          !confirm(
            "These fields have very little detail:\n\n" +
              short.join(", ") +
              "\n\nSave anyway?",
          )
        )
          return;
        fetch("/api/knowledge", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(p),
        })
          .then((r) => r.json())
          .then((d) =>
            d.success
              ? msg("Saved", false)
              : msg("Failed: " + (d.error || "Unknown"), true),
          )
          .catch((e) => msg("Error: " + e, true));
      }

      function clearAll() {
        if (!confirm("Clear all knowledge base data?")) return;
        fetch("/api/knowledge", { method: "DELETE" })
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              F.forEach((f) => (document.getElementById(f.id).value = ""));
              upd();
              msg("Cleared", false);
            } else msg("Failed to clear", true);
          })
          .catch((e) => msg("Error: " + e, true));
      }

      document.addEventListener("DOMContentLoaded", load);
    </script>
  </body>
</html>
